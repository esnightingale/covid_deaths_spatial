---
title: "Age-adjusted spatio-temporal trends in COVID-19 deaths"
author: "Emily S Nightingale"
date: "28/05/2020"
output: html_document
---

# Overview

The COVID-19 epidemic has progressed throughout the UK to different extents over the course of the last four months. As is to be expected of a contagious disease, clear variation in numbers of confirmed cases has been observed between regions based on connectivity of the population and timing of exposure (e.g. initial London hotspot). However, there is also evidence to suggest potential regional disparities in risk of fatality, independently of incident infection. Population structure with respect to age, ethnicity and affluence have likely lead to some regions experiencing a higher number of deaths than would be expected given general estimates of CFR. Some spatial information has been incorporated into mathematical modelling of the epidemic, in the form of network connectivity and contact patterns, yet exploitation of spatial structures in the data has been little explored in statistical analyses. Moreover, spatial analysis is important for interpreting raw death count and incident rate data as some of the areas have low stochastic case counts.

## Aims:

•	To fit a statistical model to recorded COVID-19 deaths in England and Wales, which takes into account not only temporal trends but spatial autocorrelation at the local authority (LA) level. 
•	From this to explore the contribution of local demographic characteristics in explaining any observed spatial correlation. 
•	To investigate any changes in the level of spatial correlation over the course of the epidemic, for example with respect to enforcement of country-wide lockdown.  
•	Do proportions of place of death vary regionally? (home, care home, hospital)

## Analysis plan:

1.	Explore appropriate temporal and spatial structures to capture the variation in weekly counts of reported deaths by local authority. 
  a.	Plot time series and map total mortality per 100,000.
  b.	Plot age distribution of fatalities per LA.
2.	Fit INLA models with a series of spatially structured random effects and identify the most appropriate for the data based on fit (offsetting for total population size).
  a.	Compare IID, Besag, BYM and BYM2 (default priors?)
  b.	Compare different prior specifications for the model selected in (a).
3.	Evaluate the addition of other explanatory factors to the chosen base model, considering how these impact the spatial structure.
  a.	Age 
    i.	mean/median age, proportion > 60/70 as covariates in above model.
    ii.	standardised offset based on national age-specific rates.
  b.	Socio-economic characteristics of local area (e.g. depravity, median gross income, % receiving income support)
  c.	Other demographic characteristics e.g. ethnicity distribution.
  d.	Connectivity, urbanity
  e.	Change point at lockdown initiation (/lagged ~ 2 weeks s.t. impact on deaths observable).
  
  
<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->
  
# Set up {.tabset .tabset-fade .tabset-pills}

```{r run_setup}

source("./code/setup.R", echo = FALSE)

```

<!-- ======================================================= -->
<!-- ======================================================= -->
<!-- ======================================================= -->

# Descriptive {.tabset .tabset-fade .tabset-pills}

## Total population

```{r mappop}

basic_map(regions, fill = "la_pop") +
  ggtitle("Total population by LA") +
  labs(fill = "")+
    annotation_scale(location = "br") 

regions %>%
  filter(geography == "London Borough") %>%
  basic_map(fill = "la_pop") +
    ggtitle("Total population by LA - London boroughs") +
    labs(fill = "")+
    annotation_scale(location = "br") 

```

## Population density

```{r dens}

regions %>%
  mutate(pop_dens = round(la_pop/as.numeric(1e-6*area_m2),0)) %>% 
basic_map(fill = "pop_dens") +
  ggtitle("Population density per KM^2 by LA") +
  labs(fill = "")+
  scale_fill_viridis_c(trans = "log") +
    annotation_scale(location = "br")  

```

## Average age
```{r mapage}

mean_age <- 
  basic_map(regions, "mean_age") +
  ggtitle("Approximate mean age by LA")+
  labs(fill = "")+
    annotation_scale(location = "br") 
med_age <- 
  basic_map(regions, "med_age") +
  ggtitle("Approximate median age")+
  labs(fill = "")

mean_age + med_age

regions %>%
filter(geography == "London Borough") %>%
basic_map("med_age") +
  ggtitle("Approximate median age")+
  labs(fill = "")

```

## Total deaths

```{r map_totals}

# Absolute and rates per 100,000
regions %>%
  full_join(d_agg_tot) %>%
  basic_map(fill = "n_total") +
  labs(title = "Total COVID19-related deaths in England and Wales, by local authority",
       subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") +
    annotation_scale(location = "br")  -> tot_map

regions %>%
  full_join(d_agg_tot) %>%
  basic_map(fill = "n_total", rate1e5 = T) +
  labs(subtitle = "Observed deaths, per 100,000", #Total COVID19-related deaths , by local authority",
       # subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") -> rate_map

regions %>%
  full_join(d_agg_tot) %>%
  basic_map(fill = "la_tot_E", rate1e5 = T) +
  labs(subtitle = "Age-adjusted expected deaths, per 100,000", #Total COVID19-related deaths , by local authority",
       # subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") -> E_map

# plasma_hml <- plasma(3)
regions %>%
  full_join(d_agg_tot) %>%
  basic_map(fill = "SIR") +
  labs(title = "Observed vs Expected deaths (SIR),\ngiven national age-specific rates", #Total COVID19-related deaths , by local authority",
       subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") +
  # scale_fill_viridis_d(option = "plasma") 
  scale_fill_gradient2(low = "dodgerblue",
                         mid = "white",
                         high = "firebrick",
                         midpoint = 1)+
    annotation_scale(location = "br")  -> SIR_map



# tot_map + rate_map
rate_map + E_map
SIR_map

```

## Over time

```{r map_totals_time}

# Absolute and rates per 100,000
d_agg_day %>%
  ggplot(aes(dod, n, group = lad19cd)) +
  geom_line(alpha = 0.3) +
  labs(title = "Total COVID19-related deaths in England and Wales, by day of death",
       subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") +
  theme_minimal() -> tot_by_day

d_agg_wk %>%
  ggplot(aes(wod, n, group = lad19cd)) +
  geom_line(alpha = 0.3) +
  labs(title = "Total COVID19-related deaths in England and Wales, by day of death",
       subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") +
  theme_minimal() -> tot_by_wk

tot_by_day
tot_by_wk


```

## Space and time

```{r sp_tmp_tot}

weekseries <- seq(min(d_agg_wk$wod), max(d_agg_wk$wod), by = 7)
exp <- data.frame(lad19cd = rep(unique(d_agg_wk$lad19cd), each = length(weekseries)),
                  wod = rep(weekseries, length(unique(d_agg_wk$lad19cd))))
d_agg_exp <- full_join(d_agg_wk, exp)

d_agg_exp %>%
  mutate(n = replace_na(n, 0)) %>% #View()
  full_join(regions, by = "lad19cd") %>%
 basic_map(fill = "n", rate1e5 = T) +
  facet_wrap(~wod) +
  labs(subtitle = "per 100,000 population", #Total COVID19-related deaths , by local authority",
       # subtitle = paste0("Data up to ", max(lubridate::ymd(covid_deaths$dor))),
       fill = "") -> rate_map_time

rate_map_time

```

# Place of death

```{r pod}

alldata %>%
  tidyr::expand(lad19cd, full_seq(wod, 7), pod2) %>%
  rename(wod = `full_seq(wod, 7)`) -> all_combs

alldata %>%
  full_join(all_combs) %>%
  group_by(lad19cd, wod, pod2) %>%
  summarise(deaths = sum(deaths, na.rm = T)) %>%
  mutate(deaths = replace_na(deaths, 0)) %>%# deaths per place
  ungroup() %>%
  full_join(dplyr::select(d_agg_wk, lad19cd, wod, n)) %>%
  mutate(n = replace_na(n, 0), #total deaths per week/LA
         prop_by_place = deaths/n) -> by_place

by_place %>%
  group_by(wod, pod2) %>%
  summarise(prop = mean(prop_by_place, na.rm = T)) %>%
  ggplot(aes(wod, prop, group = pod2, colour = pod2)) +
  geom_line() +
  labs(x = "Week", y = "Proportion", title = "Proportion of total reported COVID-19 deaths by place of death", colour = "Place of death") 

by_place %>%
  group_by(lad19cd, pod2) %>%
  summarise(deaths = sum(deaths),
            deaths_total = sum(n)) %>%
  mutate(prop_by_place = deaths/deaths_total) %>%
  # View()
  full_join(regions) %>%
  basic_map(fill = "prop_by_place") +
  facet_wrap(~pod2) +
  labs(title = "Proportion of total reported COVID-19 deaths by place of death", fill = "Proportion")

```


# Covariates {.tabset .tabset-fade .tabset-pills}

Life expectancy data are missing for a substantial number of LAs (not sure why). Instead look at indices of multiple deprivation, which are complete but only available in this form for England. Similar measures are available for Wales but do not appear to include an overall index, just the contributing metrics.

## Life expectancy

```{r cov}

d_agg %>%
  inner_join(life_exp) %>%
  full_join(regions) %>%
  basic_map(fill = "life_exp_birth") +
  labs(title = "Life expectancy at birth")

```


## Index of multiple deprivation

```{r imd}

d_agg %>%
  inner_join(imd) %>%
  inner_join(regions) %>%
  basic_map(fill = "IMD") +
  labs(title = "Index of multiple deprivation (IMD) - England",
       fill = "IMD")


```


